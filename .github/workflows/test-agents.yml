name: Test Agent Quality

on:
  pull_request:
    paths:
      - 'agents/**/*.md'
      - '!agents/README.md'
      - '!agents/TESTING.md'
      - '!agents/AGENT_CHECKLIST.md'
      - 'scripts/quality-scorer.py'
      - '.github/workflows/test-agents.yml'

jobs:
  quality-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Get changed agent files
        id: changed-files
        run: |
          # Get list of changed agent files (excluding docs)
          git fetch origin ${{ github.base_ref }}

          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | \
            grep '^agents/.*\.md$' | \
            grep -v 'README.md' | \
            grep -v 'TESTING.md' | \
            grep -v 'AGENT_CHECKLIST.md' || true)

          if [ -z "$changed_files" ]; then
            echo "No agent files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed agent files:"
            echo "$changed_files"
            echo "$changed_files" > changed_agents.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Run quality scoring on changed agents
        id: quality-score
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "# Quality Scoring Results" > quality-results.txt
          echo "" >> quality-results.txt

          all_passed=true
          min_score=8.0

          while IFS= read -r agent_file; do
            if [ -f "$agent_file" ]; then
              echo "Evaluating: $agent_file"

              # Run quality scorer
              output=$(python3 scripts/quality-scorer.py --agent "$agent_file" 2>&1 || true)

              # Extract score
              score=$(echo "$output" | grep "Quality Score:" | awk '{print $3}')
              tier=$(echo "$output" | grep "Tier:" | sed 's/Tier: //')

              echo "## $(basename $agent_file)" >> quality-results.txt
              echo "**Score:** $score | **Tier:** $tier" >> quality-results.txt
              echo "" >> quality-results.txt

              # Check if score meets minimum threshold
              if [ -n "$score" ]; then
                if (( $(echo "$score < $min_score" | bc -l) )); then
                  echo "âš ï¸ **Score below minimum threshold ($min_score)**" >> quality-results.txt
                  all_passed=false
                else
                  echo "âœ… Score meets quality threshold" >> quality-results.txt
                fi
              else
                echo "âŒ Failed to evaluate agent" >> quality-results.txt
                all_passed=false
              fi

              # Add detailed metrics
              echo "<details><summary>Detailed Metrics</summary>" >> quality-results.txt
              echo "" >> quality-results.txt
              echo '```' >> quality-results.txt
              echo "$output" >> quality-results.txt
              echo '```' >> quality-results.txt
              echo "</details>" >> quality-results.txt
              echo "" >> quality-results.txt
            fi
          done < changed_agents.txt

          if [ "$all_passed" = true ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate quality report artifact
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # Generate full quality report for all changed agents
          python3 scripts/quality-scorer.py --agents-dir agents --output quality-report.json

      - name: Upload quality report
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            quality-report.json
            quality-results.txt
          retention-days: 30

      - name: Comment PR with quality results
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ðŸŽ¯ Agent Quality Report\n\n';

            if (fs.existsSync('quality-results.txt')) {
              const results = fs.readFileSync('quality-results.txt', 'utf8');
              comment += results;
            } else {
              comment += 'No quality results available.';
            }

            comment += '\n\n---\n';
            comment += '*Minimum quality threshold: 8.0*\n';
            comment += '*View detailed report in workflow artifacts*';

            // Find existing comment and update, or create new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Agent Quality Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Enforce quality threshold
        if: steps.changed-files.outputs.has_changes == 'true' && steps.quality-score.outputs.passed == 'false'
        run: |
          echo "::error::One or more agents failed to meet the minimum quality threshold (8.0)"
          echo "Please review the quality report above and improve agent quality before merging."
          exit 1

      - name: Quality check passed
        if: steps.changed-files.outputs.has_changes == 'true' && steps.quality-score.outputs.passed == 'true'
        run: |
          echo "âœ… All changed agents meet quality standards"
